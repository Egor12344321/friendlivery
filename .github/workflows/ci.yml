name: CI/CD

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/friendlivery

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-v2
          docker compose version

      - name: Run tests
        run: mvn clean test

      - name: Build JAR packages
        run: mvn clean package -DskipTests

      - name: Build Docker images
        run: |
          services=("auth" "delivery" "payment" "flight" "notification" "chat" "gateway")
          
          for service in "${services[@]}"; do
            docker build \
              -t ghcr.io/$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')/friendlivery-$service:latest \
              -f $service-service/Dockerfile ./$service-service
          done

      - name: Start services with health checks
        run: |
          docker compose up -d
          
          wait_for_service() {
            local service=$1
            local port=$2
            local timeout=60
            local counter=0
          
            while [ $counter -lt $timeout ]; do
              if curl -s -f "http://localhost:$port/actuator/health" > /dev/null; then
                return 0
              fi
          
              sleep 5
              counter=$((counter + 1))
            done
          
            return 1
          }
          
          wait_for_service "gateway" 8080 || true
          wait_for_service "auth" 8081 || true
          wait_for_service "delivery" 8082 || true

      - name: Run integration tests
        run: |
          RUNNING_CONTAINERS=$(docker compose ps --services --filter "status=running" | wc -l)
          echo "Running containers: $RUNNING_CONTAINERS"
          
          if [ "$RUNNING_CONTAINERS" -lt 5 ]; then
            echo "Not all containers are running: $RUNNING_CONTAINERS"
            docker compose ps
            exit 1
          fi

      - name: Debug on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=50

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f