name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKERHUB_NAMESPACE: "epapakin"
  STACK_NAME: "friendlivery"

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn clean test

  build_and_push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR packages
        run: mvn clean package -DskipTests

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push images
        run: |
          services=("auth" "delivery" "payment" "flight" "notifications" "chat")
          
          for service in "${services[@]}"; do
            echo "Building $service-service"
            IMAGE_TAG="${{ env.DOCKERHUB_NAMESPACE }}/friendlivery-$service:latest"
            cd $service-service
            docker build -t $IMAGE_TAG .
            docker push $IMAGE_TAG
            cd ..
          done
          
          echo "Building api-gateway"
          IMAGE_TAG="${{ env.DOCKERHUB_NAMESPACE }}/friendlivery-gateway:latest"
          cd api-gateway
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

  deploy_swarm:
    name: Deploy to Swarm
    runs-on: self-hosted
    needs: build_and_push
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' && 
      github.actor == 'Egor12344321'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull latest images
        shell: powershell
        run: |
          $services = @("auth", "delivery", "payment", "flight", "notifications", "chat", "gateway")
          $namespace = "${{ env.DOCKERHUB_NAMESPACE }}"

          foreach ($service in $services) {
            if ($service -eq "gateway") {
              $image = "$namespace/friendlivery-gateway:latest"
            } else {
              $image = "$namespace/friendlivery-$service:latest"
            }
            Write-Host "Pulling $image"
            docker pull $image
          }

      - name: Deploy to Swarm
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          
          $result = cmd /c "docker stack deploy -c docker-stack.yml ${{ env.STACK_NAME }} --with-registry-auth --resolve-image always" 2`>`&1
          Write-Host $result
          
          Write-Host "Stack deployment completed"
          exit 0
      - name: Wait for API Gateway port
        shell: powershell
        run: |
          Write-Host "Waiting for port 8080 to open..."
          $maxWait = 180  # 3 минуты
          $waitInterval = 5
          $elapsed = 0

          while ($elapsed -lt $maxWait) {
            try {
              $tcp = New-Object System.Net.Sockets.TcpClient
              $tcp.Connect("localhost", 8080)
              $tcp.Close()
              Write-Host "Port 8080 is open after $elapsed seconds!"
              break
            } catch {
              Write-Host "Waiting for port 8080... ($elapsed/$maxWait seconds)"
              Start-Sleep -Seconds $waitInterval
              $elapsed += $waitInterval
            }
          }

          if ($elapsed -ge $maxWait) {
            Write-Host "WARNING: Port 8080 check timeout, but continuing deployment..."
          }
      - name: Verify deployment
        shell: powershell
        run: |
          Write-Host "=== FINAL DEPLOYMENT CHECK ==="
          
          try {
            $tcp = New-Object System.Net.Sockets.TcpClient
            $tcp.Connect("localhost", 8080)
            $tcp.Close()
            Write-Host "Port 8080 open"
          } catch {
            Write-Host "Port 8080 not accessible"
            exit 1
          }

      - name: Show running services
        shell: powershell
        run: |
          Write-Host "Final stack status:"
          docker stack ps ${{ env.STACK_NAME }}