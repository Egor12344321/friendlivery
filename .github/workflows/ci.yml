name: CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build services with Maven
        run: |
          mvn clean package -DskipTests
          find . -name "*.jar" | head -10

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install docker-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Build auth-service
        run: docker build -t friendlivery-auth:latest -f auth-service/Dockerfile ./auth-service

      - name: Build delivery-service
        run: docker build -t friendlivery-delivery:latest -f delivery-service/Dockerfile ./delivery-service

      - name: Build payment-service
        run: docker build -t friendlivery-payment:latest -f payment-service/Dockerfile ./payment-service

      - name: Build flight-service
        run: docker build -t friendlivery-flight:latest -f flight-service/Dockerfile ./flight-service

      - name: Build notifications-service
        run: docker build -t friendlivery-notifications:latest -f notifications-service/Dockerfile ./notifications-service

      - name: Build chat-service
        run: docker build -t friendlivery-chat:latest -f chat-service/Dockerfile ./chat-service

      - name: Build gateway-service
        run: docker build -t friendlivery-gateway:latest -f api-gateway/Dockerfile ./api-gateway

      - name: Deploy and test
        run: |
          docker-compose up -d
          sleep 250
          
          services=("auth-service" "delivery-service" "payment-service" "flight-service" "notifications-service" "chat-service")
          
          for service in "${services[@]}"; do
            if [ -z "$(docker ps -q -f name=$service)" ]; then
              echo "Error: $service container is not running"
              docker-compose logs $service
              docker-compose down
              exit 1
            fi
          done
          
          
          if curl -s http://localhost:8081 > /dev/null; then
            echo "Auth service is working"
          else
            echo "Auth service not responding"
            exit 1
          fi
          
          echo "All services are running successfully"

      - name: Cleanup
        if: always()
        run: docker-compose down